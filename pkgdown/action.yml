name: Build package documentation
description: use pkgdown to build and deploy package documentation
inputs:
    run-only:
      description: Skip the setup steps and run directly, assuming that setup was run.
      required: false
      default: false
    user-email:
      description: E-mail address to which commit should be attributed
      required: false
      default: 'actions@github.com'
    user-name:
      description: User name to which commit should be attributed
      required: false
      default: 'GitHub Actions'

runs:
  using: 'composite'
  steps:
    - uses: actions/checkout@v3

    - uses: r-lib/actions/setup-pandoc@v2

    - uses: r-lib/actions/setup-r@v2
      with:
        use-public-rspm: true

    - name: Install Mac OS dependencies
      if: runner.os == 'MacOS'
      run: |
        brew install libgit2
      shell: bash
      
    - name: Install libcurl
      if: runner.os == 'Ubuntu'
      run: |
        sudo apt-get install libcurl4-openssl-dev
      shell: bash

    - name: Git credentials
      run: |
        git config --local user.email "${{ inputs.user-email }}"
        git config --local user.name "${{ inputs.user-name }}"
      shell: bash

    - uses: r-lib/actions/setup-r-dependencies@v2
      with:
        extra-packages: any::pkgdown, local::.
        needs: website

    - name: Build and deploy documentation
      run: |
        pkgdown::deploy_to_branch(new_process = FALSE)
        if (length(warnings()) > 0) {
          stop("Fail on warning")
        }
      shell: Rscript {0}
